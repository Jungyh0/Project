{% block content %}

{% if message %}
    <script type="text/javascript" language="JavaScript">
        alert("{{ message }}");
    </script>
{% endif %}

<style>
    /* ì—¬ê¸°ì— ìœ„ ê³µí†µ CSS ìŠ¤íƒ€ì¼ ë‚´ìš©ì„ ë¶™ì—¬ë„£ìŠµë‹ˆë‹¤. */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        background-image: url('static/assets/3_8.png');
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center center;
        background-color: #ffffff;
        
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    }

    /* ğŸŒŸğŸŒŸğŸŒŸ ìˆ˜ì •ëœ ì¹´ë©”ë¼ ëª¨ë“ˆ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜•) ğŸŒŸğŸŒŸğŸŒŸ */
    .camera-module-container {
         position: absolute;

        /* í™•ì •ëœ ë°˜ì‘í˜• í¬ê¸° ì ìš© */
        width: 84vw;
        max-width: 920px;
        height: 41vh;
        max-height: 700px;

        /* í™•ì •ëœ ìœ„ì¹˜ ì ìš© */
        top: 15.6%;
        left: 50.5%;
        transform: translateX(-50%);

        background-color: #000000;
    }

    .camera-module-container video,
    .camera-module-container canvas {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        object-fit: cover;
    }

    .camera-module-container video {
        transform: scaleX(-1);
        filter: FlipH;
        z-index: 10;
    }

    .camera-module-container canvas {
        visibility: hidden;
        z-index: 5;
    }

    .page-number-display {
        position: absolute;
        bottom: 10%;
        left: 50%;
        transform: translateX(-50%);
        color: #333;
        font-size: 24px;
        font-weight: bold;
    }
</style>

<body>

    <div class="camera-module-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    </body>

<script>
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        var video = document.getElementById('video');
        if (video) {
            video.srcObject = stream;
        }
    }, function(err) {
        console.error("ì›¹ìº ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", err);
    });
} else {
    console.error("getUserMediaê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
}

var canvas = document.getElementById('canvas');
var video = document.getElementById('video');
var context;
var formData = new FormData();

if (canvas && video) {
    video.onloadedmetadata = function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context = canvas.getContext('2d');
        console.log("page_3_8: ë¹„ë””ì˜¤ ë° ìº”ë²„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ. ìº¡ì²˜ ëŒ€ê¸° ì¤‘...");
        setTimeout(capture, 1000);
        setTimeout(send, 2000);
    };
}

function capture() {
    if (!context) { console.error("Canvas contextê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); return; }
    console.log("page_3_8: ìº¡ì²˜ ì‹¤í–‰");
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    var imgData = canvas.toDataURL('image/png');
    var binaryData = atob(imgData.split(',')[1]);
    var array = [];
    for (var i = 0; i < binaryData.length; i++) { array.push(binaryData.charCodeAt(i)); }
    var file = new File([new Uint8Array(array)], "capture.png", {type: 'image/png'});
    formData.append('up_file', file);
    console.log("page_3_8: ì´ë¯¸ì§€ ìº¡ì²˜ ë° formDataì— ì¶”ê°€ë¨");
}

function send() {
    if (formData.has('up_file')) {
        console.log("page_3_8: ë°ì´í„° ì „ì†¡ ì‹œë„: /page_3_8"); // ğŸŒŸ ìˆ˜ì •ë¨
        fetch('/page_3_8', { // ğŸŒŸ ìˆ˜ì •ë¨
            method: 'POST',
            body: formData,
        }).then((response) => {
            console.log("page_3_8: ì„œë²„ ì‘ë‹µ ë°›ìŒ, í˜ì´ì§€ ì´ë™: ", response.url);
            window.location.replace(response.url);
        }).catch((error) => {
            console.error("page_3_8: ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ", error);
        });
    } else {
        console.warn("page_3_8: ì „ì†¡í•  ìº¡ì²˜ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
    }
}
</script>

{% endblock %}