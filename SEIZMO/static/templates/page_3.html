{% block content %}

{% if message %}
    <script type="text/javascript" language="JavaScript">
        // ì´ ìŠ¤í¬ë¦½íŠ¸ ë¸”ë¡ì€ messageê°€ ìˆì„ ë•Œë§Œ ìƒì„±ë¨
        alert("{{ message }}");
    </script>
{% endif %}

<style>
    /* Pretendard í°íŠ¸ ì •ì˜ (í•„ìš”í•œ ê²½ìš°) */
    /*
    @font-face {
        font-family: 'Pretendard-Regular';
        src: url('https://fastly.jsdelivr.net/gh/Project-Noonnu/noonfonts_2107@1.1/Pretendard-Regular.woff') format('woff');
        font-weight: 400;
        font-style: normal;
    }
    */

    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        /* font-family: 'Pretendard-Regular', sans-serif; /* í°íŠ¸ ì ìš© (ìœ„ @font-face ì •ì˜ í›„) */
    }

    body {
        background-image: url('static/assets/3_1.png');
        background-repeat: no-repeat;
        background-size: contain;
        background-position: center center;
        background-color: #ffffff;
        
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    }

    /* ğŸŒŸğŸŒŸğŸŒŸ ìˆ˜ì •ëœ ì¹´ë©”ë¼ ëª¨ë“ˆ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ (ë°˜ì‘í˜•) ğŸŒŸğŸŒŸğŸŒŸ */
    .camera-module-container {
        position: absolute;

        /* í™•ì •ëœ ë°˜ì‘í˜• í¬ê¸° ì ìš© */
        width: 84vw;
        max-width: 920px;
        height: 41vh;
        max-height: 700px;

        /* í™•ì •ëœ ìœ„ì¹˜ ì ìš© */
        top: 15.6%;
        left: 50.5%;
        transform: translateX(-50%);

        background-color: #000000; /* ë¹„ë””ì˜¤ ë¡œë”© ì „ ê²€ì€ìƒ‰ ë°°ê²½ */
    }

    .camera-module-container video,
    .camera-module-container canvas {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        object-fit: cover;
    }

    .camera-module-container video {
        transform: scaleX(-1);
        filter: FlipH;
        z-index: 10;
    }

    .camera-module-container canvas {
        visibility: hidden;
        z-index: 5;
    }

</style>

<body>

    <div class="camera-module-container">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

</body>

<script>
// JavaScript ìƒë‹¨ì˜ ì¤‘ë³µë˜ëŠ” message alert ë¡œì§ì€ HTML ë¶€ë¶„ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ì œê±°í–ˆìŠµë‹ˆë‹¤.

if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function(stream) {
        var video = document.getElementById('video');
        if (video) {
            video.srcObject = stream;
            // autoplay ì†ì„±ìœ¼ë¡œ ì¸í•´ ëª…ì‹œì ì¸ video.play() í˜¸ì¶œì€ ìƒëµ ê°€ëŠ¥í•  ìˆ˜ ìˆìŒ
        }
    }, function(err) {
        console.error("ì›¹ìº ì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", err);
    });
} else {
    console.error("getUserMediaê°€ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
}

var canvas = document.getElementById('canvas');
var video = document.getElementById('video');
var context;
var formData = new FormData();

if (canvas && video) {
    video.onloadedmetadata = function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context = canvas.getContext('2d');
        console.log("ë¹„ë””ì˜¤ ë° ìº”ë²„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ. ìº¡ì²˜ ëŒ€ê¸° ì¤‘...");

        setTimeout(capture, 1000);
        setTimeout(send, 2000);
    };
}

function capture() {
    if (!context) {
        console.error("Canvas contextê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        return;
    }
    console.log("ìº¡ì²˜ ì‹¤í–‰");
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    var imgData = canvas.toDataURL('image/png');
    var binaryData = atob(imgData.split(',')[1]);
    var array = [];
    for (var i = 0; i < binaryData.length; i++) {
        array.push(binaryData.charCodeAt(i));
    }
    var file = new File([new Uint8Array(array)], "capture.png", {type: 'image/png'});
    formData.append('up_file', file);
    console.log("ì´ë¯¸ì§€ ìº¡ì²˜ ë° formDataì— ì¶”ê°€ë¨");
}

function send() {
    if (formData.has('up_file')) {
        console.log("ë°ì´í„° ì „ì†¡ ì‹œë„: /page_3"); // ğŸŒŸ ìˆ˜ì •ë¨
        fetch('/page_3', { // ğŸŒŸ ìˆ˜ì •ë¨
            method: 'POST',
            body: formData,
        }).then((response) => {
            console.log("ì„œë²„ ì‘ë‹µ ë°›ìŒ, í˜ì´ì§€ ì´ë™: ", response.url);
            window.location.replace(response.url);
        }).catch((error) => {
            console.error("ë°ì´í„° ì „ì†¡ ì‹¤íŒ¨: ", error);
        });
    } else {
        console.warn("ì „ì†¡í•  ìº¡ì²˜ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
    }
}
</script>

{% endblock %}